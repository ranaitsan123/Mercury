# Mercury Backend – Developer Details (`dev_setup.md`)

This document provides detailed guidance for developers working on the Mercury backend system. It covers environment setup, project structure, key concepts, coding standards, and development workflows.

---

## 1. Project Setup

### Prerequisites

- Python 3.11+
- PostgreSQL
- Node.js (optional, for frontend integration)
- Redis (for GraphQL subscriptions)
- Virtual environment (`venv` or `pipenv`)

### Steps to Setup Locally

1. Clone the repository:

```bash
git clone <repo_url>
cd Mercury/backend
````

2. Create and activate a virtual environment:

```bash
python -m venv venv
source venv/bin/activate
```

3. Install dependencies:

```bash
pip install -r requirements.txt
```

4. Configure environment variables (example `.env`):

```text
DJANGO_SECRET_KEY=your_secret_key
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=mercury
POSTGRES_USER=mercury_user
POSTGRES_PASSWORD=your_password
USE_REAL_SERVICES=false
MAILSERVER_API_KEY=secret123
REDIS_URL=redis://localhost:6379/0
```

5. Apply database migrations:

```bash
python manage.py migrate
```

6. Create a superuser for admin access:

```bash
python manage.py createsuperuser
```

7. Start the development server:

```bash
python manage.py runserver
```

8. Start Redis for subscriptions (if applicable):

```bash
redis-server
```

---

## 2. Project Structure Overview

```
backend/
├─ emails/           # Email models, schema, mock service
├─ scanner/          # AI scanner models, schema, service selector
├─ middleware/       # Custom request/response middlewares
├─ users/            # User management, JWT authentication
├─ backend/          # Project settings and main URLs
├─ tests/            # Test suite (pytest)
├─ docs/             # Documentation (signals, middleware, security, etc.)
```

---

## 3. Key Concepts

### GraphQL API

* Queries: Fetch emails (`myEmails`), scan logs (`myScanLogs`, `scanLogs`)
* Mutations: Send emails (`sendEmail`) – scans happen automatically
* Subscriptions: Real-time updates for new emails and scan results

### Automatic Scanning

* All emails (sent or received) are scanned automatically
* Scan results are stored in `ScanLog`
* Frontend never triggers scans directly

### Middleware

* **SecurityGatewayMiddleware**: Adds unique trace IDs
* **IntelligentServiceRouterMiddleware**: Routes requests to mock or real services
* **ResponseLoggingMiddleware**: Injects trace IDs into responses
* **ApiKeyGateMiddleware**: Protects sensitive endpoints like `/scanner/scan/`

---

## 4. Coding Standards

* Use **PEP8** compliant formatting
* Use **snake_case** for variables and function names
* Use **PascalCase** for class names
* Write **unit tests** for new features
* Use `@login_required` for any user-specific endpoint
* Use `@admin_required` for admin-only queries

---

## 5. Development Workflow

1. **Branching Strategy:**

   * `main` – production-ready code
   * `dev` – integration branch
   * Feature branches: `feature/<name>`

2. **Testing:**

   * Run tests before commit:

```bash
pytest --ds=backend.settings -v --cov
```

3. **Linting:**

   * Check code style:

```bash
flake8 backend/
```

4. **Commits:**

   * Use meaningful commit messages
   * Reference Jira/issue ticket if available

5. **Pull Requests:**

   * Ensure all tests pass
   * Include documentation updates if needed

---

## 6. Debugging Tips

* Enable Django debug mode in `.env`:

```text
DEBUG=True
```

* Use Django shell for testing:

```bash
python manage.py shell
```

* Inspect middleware traces via `request.trace_id`
* Check Redis connection for subscriptions

---

## 7. Environment Management

* **Local development:** `USE_REAL_SERVICES=false`
* **Staging/Production:** `USE_REAL_SERVICES=true`
* Always secure `.env` files – never commit secrets

---

## 8. Useful Commands

* Run server: `python manage.py runserver`
* Run tests: `pytest`
* Run migrations: `python manage.py migrate`
* Create superuser: `python manage.py createsuperuser`
* Collect static files: `python manage.py collectstatic`
* Open Django shell: `python manage.py shell`
* Start Redis: `redis-server`

---

## 9. Notes

* Developers should not interact directly with AI scanning – system handles scans automatically
* Email sending and scan results are routed based on service configuration (`mock` vs `real`)
* Always use authenticated clients in tests

---

This document ensures developers understand the Mercury backend system’s structure, workflow, and conventions to develop safely and effectively.

