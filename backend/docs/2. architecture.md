# Mercury Backend Architecture

This document provides a high-level overview of the Mercury backend system, including its layers, data flow, and interactions between components.

## 1. Overview

The backend is structured in layers to ensure clean separation of concerns:

```

Frontend (React / Vue / etc.)
│
▼
GraphQL API (Queries, Mutations, Subscriptions)
│
▼
Models & Signals (Email, ScanLog)
│
▼
Middleware (Security, Routing, Logging)
│
▼
External Services (Mailserver, AI Scanner)

```

**Key Principles:**
- **Separation of concerns:** Each layer has a single responsibility.
- **Automatic scanning:** Users do not perform scans manually; the system triggers them on sent/received emails.
- **GraphQL as single API:** The frontend interacts exclusively via GraphQL queries, mutations, and subscriptions.

---

## 2. Backend Layers

### 2.1 GraphQL API
- Handles queries, mutations, and subscriptions.
- Exposes the inbox (`myEmails`), sent folder, and scan logs.
- Responsible for validating user access.
- Examples:
  - Query: `myEmails(folder: "inbox")`
  - Mutation: `sendEmail(to, subject, body)`

### 2.2 Models & Signals
- **Email model:** Stores sender, recipient, subject, body, folder, outgoing status.
- **ScanLog model:** Stores scan results, confidence score, linked to Email via OneToOne.
- **Signals:** Trigger automatic scanning after an email is sent or received.

### 2.3 Middleware
- **SecurityGatewayMiddleware:** Adds trace IDs for requests.
- **IntelligentServiceRouterMiddleware:** Determines whether mock or real services are used.
- **ResponseLoggingMiddleware:** Logs responses with trace IDs.

### 2.4 External Services
- **Mailserver:** Real or mock service for sending emails.
- **AI Scanner:** Real or mock service for scanning email content.
- **Redis:** Used for GraphQL subscriptions and pub/sub notifications.

---

## 3. Data Flow

1. **User sends email via frontend.**
2. **GraphQL mutation** (`sendEmail`) is called.
3. Email is **saved in the database** with `folder="sent"`.
4. **Signal triggers scanner** (mock or real) automatically.
5. **ScanLog is created** and linked to the Email.
6. **Frontend receives updates** via subscriptions (`email_created`, `scan_completed`).

---

## 4. Notes for Frontend Developers

- Use **GraphQL queries** to fetch inbox/sent items.
- Subscribe to **new email or scan updates** via GraphQL subscriptions.
- Do **not call scanning manually**; the backend handles it automatically.

---

## 5. Diagram

```

Frontend
│
▼
GraphQL API
│
▼
Email / ScanLog Models
│
▼
Signals (Auto Scan)
│
▼
Middleware & External Services

```

> Optional: Use Mermaid.js or another diagramming tool for a visual representation.

---

This architecture ensures:
- Consistency between frontend and backend.
- Automated scanning and logging.
- Clean separation between models, services, and API layers.


