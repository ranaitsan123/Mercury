# Mercury Backend Tests Documentation

This document explains the structure, purpose, and execution of the backend tests for the Mercury system. It covers authentication, email services, middleware, routing, AI scanning, and user management.

---

## 1. Overview

The backend tests ensure that:

- All APIs function as expected.
- Middleware behaves correctly.
- Service routing works (mock vs real).
- Authentication and authorization are enforced.
- AI scanning logs are created automatically.

**Tools used:**

- `pytest` – test runner.
- `pytest-django` – Django integration.
- `pytest-cov` – coverage reporting.
- `Django REST Framework TestClient` – API testing.
- `Django RequestFactory` – middleware testing.
- `monkeypatch` – environment variable mocking.

---

## 2. Test Files

### 2.1 `test_emails.py`

**Purpose:** Test email sending functionality.

**Tests:**

- `test_mock_send_email()`  
  Verifies that mock email sending works correctly:
  - Sends a test email via `/emails/mock/send/`.
  - Confirms the response status and `status` field.

**Requirements:**

- Authenticated user (JWT token).
- Mock email service available.

---

### 2.2 `test_middleware.py`

**Purpose:** Test custom middleware components.

**Middleware Tested:**

1. **SecurityGatewayMiddleware**  
   - Adds unique `trace_id` to each request.
   - `test_security_gateway_adds_trace_id()` validates UUID format.

2. **IntelligentServiceRouterMiddleware**  
   - Adds `service_route` to requests.
   - `test_router_sets_service_route()` ensures the router assigns `"mock"` or `"real"`.

3. **ResponseLoggingMiddleware**  
   - Injects `trace_id` into response JSON.
   - `test_response_logger_injects_trace()` verifies logging.

---

### 2.3 `test_routing.py`

**Purpose:** Test intelligent service router behavior based on environment variables.

**Tests:**

- `test_router_mock_mode()`  
  Ensures routing goes to mock services when `USE_REAL_SERVICES=false`.

- `test_router_real_mode()`  
  Ensures routing goes to real services when `USE_REAL_SERVICES=true`.

**Environment Variables:**

- `USE_REAL_SERVICES` – controls routing.
  - `"true"` → real services
  - `"false"` → mock services

---

### 2.4 `test_scanner.py`

**Purpose:** Test AI scanning functionality.

**Tests:**

- `test_scan_creates_log()`  
  - Sends a scan request.
  - Checks response and confirms `ScanLog` entry in DB.

- `test_logs_list()`  
  - Creates multiple scan logs.
  - Retrieves logs via `/scanner/logs/`.
  - Validates response list.

**Notes:** Scanning is automatic for all emails sent/received.

---

### 2.5 `test_users.py`

**Purpose:** Test user authentication and profile endpoints.

**Tests:**

- `test_user_me()`  
  - Creates a test user.
  - Authenticates with JWT token.
  - Fetches user profile via `/users/me/`.
  - Validates response username.

**Key Endpoints:**

- `POST /auth/token/` – Obtain JWT token.
- `GET /users/me/` – Retrieve authenticated user profile.

---

### 2.6 `test_api_key_auth.py`

**Purpose:** Test API key authentication middleware.

**Tests:**

- `test_api_key_valid()` – Valid API key allows access.
- `test_api_key_missing()` – Missing key returns 401.
- `test_api_key_invalid()` – Invalid key returns 401.
- `test_api_key_not_required_for_other_endpoints()` – API key only required for specific endpoints.
- `test_api_key_caching()` – Middleware caches key at initialization.

---

## 3. Test Execution

### Run All Tests

```bash
pytest
````

### Run Specific Test File

```bash
pytest tests/test_emails.py
```

### Run Specific Test Function

```bash
pytest tests/test_scanner.py::test_scan_creates_log
```

### Verbose Output

```bash
pytest -v
```

### Coverage Report

```bash
pytest --cov=.
```

### Django Database

```bash
pytest --ds=backend.settings
```

---

## 4. Test Best Practices

1. Use `@pytest.mark.django_db` for tests accessing the database.
2. Authenticate properly for JWT-protected endpoints.
3. Keep tests isolated – each test should run independently.
4. Mock environment variables for service routing tests.
5. Use descriptive names for tests.

---

## 5. Notes for Frontend Developers

* Mock services allow frontend development without relying on real backend services.
* Middleware tests ensure request routing and logging function correctly.
* Scanner tests guarantee that emails are scanned automatically.
* Authentication tests verify JWT token handling.

---

